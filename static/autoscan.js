// autoscan.js

// Function to handle file input change
function handleFileInputChange() {
  var fileInput = document.getElementById("file-input");
  var uploadButton = document.getElementById("upload-button");
  if (fileInput.files.length > 0) {
    uploadButton.style.display = "block";
  } else {
    uploadButton.style.display = "none";
  }
}

// Function to handle form submission
function handleUploadFormSubmit(event) {
  // Code to handle form submission
  // Use Fetch API to submit the form data asynchronously
  fetch('{{ url_for("upload_file") }}', {
    method: "POST",
    body: new FormData(event.target),
  })
    .then((response) => response.json())
    .then((data) => {
      console.log(data);
      // Update the filename and show the Start Scan button
      document.getElementById(
        "upload-message"
      ).innerText = `Upload successful: ${data.filename}`;
      document.getElementById("upload-message").style.display = "block";
      document.getElementById("scan-button").style.display = "block";
    })
    .catch((error) => {
      console.error("Error:", error);
    });

  // Prevent the form from submitting normally
  //event.preventDefault();
}

// Function to delete a file
function deleteFile(fileId) {
  if (confirm("Are you sure you want to delete this file?")) {
    fetch("/delete_file/" + fileId, {
      method: "POST",
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Reload the page to update the table
          location.reload();
        } else {
          alert("Failed to delete file");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
      });
  }
}

// Function to start Scan
function startScan(event, fileId) {
  // Prevent the default form submission behavior
  event.preventDefault();

  // Display the scanning popup
  document.getElementById("scan-popup").innerText = "Scanning...";
  document.getElementById("scan-popup").style.display = "block";

  // Start the scan
  fetch(`/start_scan/${fileId}`, {
    method: "POST",
  })
    .then((response) => response.json())
    .then((data) => {
      if (!("error" in data)) {
        // Hide the scanning popup and show "Scan complete"
        document.getElementById("scan-popup").innerText = "Scan complete";
        document.getElementById("scan-results").innerText = JSON.stringify(
          data.report
        );
        document.getElementById("scan-results").style.display = "block";
      } else {
        // Handle the error
        document.getElementById("scan-popup").innerText = "Scan complete";
      }
    })
    .catch((error) => {
      console.error("Error:", error);
      document.getElementById("scan-popup").innerText = "Scan complete";
    });
}

// Function to view the report
function viewReport(event, fileId) {
  // Prevent the default form submission behavior
  event.preventDefault();

  // Fetch the report for the file
  fetch(`/view_report/${fileId}`)
    .then((response) => response.json())
    .then((data) => {
      // Display the report in the 'scan-results' div
      document.getElementById("scan-results").innerText = JSON.stringify(
        data.report
      );
      document.getElementById("scan-results").style.display = "block";
    })
    .catch((error) => {
      console.error("Error:", error);
      // Display an error message
      document.getElementById("scan-results").innerText =
        "Failed to fetch report.";
      document.getElementById("scan-results").style.display = "block";
    });
}

// Add event listeners
document
  .getElementById("file-input")
  .addEventListener("change", handleFileInputChange);
document
  .getElementById("upload-form")
  .addEventListener("submit", handleUploadFormSubmit);
