{% extends 'base.html' %}

{% block title %}Autoscan{% endblock %}

{% block content %}
{% include 'navbar.html' %}

<!-- Where flash messages will be displayed -->
<div id="flash-messages" data-flash-messages="{{ get_flashed_messages(with_categories=true) | tojson | safe }}"></div>
<h2>Autoscan</h2>
<p>This page will be used for automated malware analysis.</p>

<!-- Upload file to uploads directory  -->
<form id="upload-form" method="POST" enctype="multipart/form-data" action="{{ url_for('upload_file') }}">
    <input type="file" name="file">
    <input type="submit" value="Upload">
</form>
<div id="upload-message" style="display: none;">Upload successful</div>

<!-- ONCE FILE HAS SUCCESSFULLY BEEN UPLOADED... -->
<script>
document.getElementById('upload-form').addEventListener('submit', function(event) {
    // Remove event.preventDefault(); to allow the form to submit normally
    // Code to add the Scan button goes here
    document.getElementById('upload-message').style.display = 'block';
    document.getElementById('scan-button').style.display = 'block';

    // Use Fetch API to submit the form data asynchronously
    fetch('{{ url_for("upload_file") }}', {
        method: 'POST',
        body: new FormData(event.target)
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        // Update the filename and show the Start Scan button
        document.getElementById('upload-message').innerText = `Upload successful: ${data.filename}`;
        document.getElementById('upload-message').style.display = 'block';
        document.getElementById('scan-button').style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
    });

    // Prevent the form from submitting normally
    event.preventDefault();
});

</script>

<button id="scan-button" style="display: none;" onclick="startScan('{{ filename }}')">Start Scan</button>

<div id="output" style="display: none;">{{ output }}</div>

<button onclick="toggleConsole()" style="display: none;">Toggle Console</button>
<div id="console" style="display: none;">{{ output }}</div>

<script>
function toggleConsole() {
    var console = document.getElementById("console");
    if (console.style.display === "none") {
        console.style.display = "block";
    } else {
        console.style.display = "none";
    }
}
</script>

<script>
    function startScan(filename) {
    fetch('{{ url_for("start_scan", filename=filename) }}', {
        method: 'POST'
    })
    .then(response => response.text())  // Change to text() to handle HTML response
    .then(data => {
        console.log(data);
        // Check if the response contains the output or error message
        if (data.includes('<!DOCTYPE')) {
            // If response contains HTML, display an error message
            document.getElementById('output').innerText = 'Error occurred. Please check the server logs.';
        } else {
            // If response contains text output, display it
            document.getElementById('output').innerText = data;
        }
        document.getElementById('output').style.display = 'block';
        document.getElementById('toggle-console-button').style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

</script>


<!-- Page End -->
</div>
{% endblock %}
