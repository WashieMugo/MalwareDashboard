{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}


{% block content %}

{% include 'navbar.html' %}

<!-- Where flash messages will be displayed -->
<div id="flash-messages" data-flash-messages="{{ get_flashed_messages(with_categories=true) | tojson | safe }}"></div>

<!-- Main content -->
  <!-- <h2>Welcome to the Dashboard, {{ session['username'] }}!</h2> -->
    
  <h3>Actions:</h3>
  <form method="POST" action="{{ url_for('dashboard') }}" enctype="multipart/form-data">
    {{ upload_form.hidden_tag() }}
    <p>{{ upload_form.malware_file.label }}<br>{{ upload_form.malware_file(size=32) }}</p>
    <p>{{ upload_form.submit_upload() }}</p>
  </form>

  <h3>Start Sandbox:</h3>
  <form method="POST" action="{{ url_for('start_sandbox') }}">
    <p><button type="submit" class="btn btn-secondary">Start Sandbox</button></p>
  </form>

  <!-- VM Information Table -->
<table class="table">
  <thead>
    <tr>
      <th>#</th>
      <th>VM Name</th>
      <th>Type</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for vm in vm_info %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ vm['name'] }}</td>
        <td>{{ vm['ostype']}}</td>  <!-- You can make this dynamic based on your VM type -->
        <td>{{ vm['status'] }}</td>
        <td>
          {% if vm['status'] == 'Running' %}
            <a href="{{ url_for('view_vm', vm_name=vm['name']) }}" class="btn btn-primary">View</a>
            <form method="post" action="{{ url_for('stop_vm', vm_name=vm['name']) }}" onsubmit="return confirmShutdown()">
              <button type="submit" {% if vm['status'] != 'Running' %}disabled{% endif %} class="btn btn-danger">Stop</button>
            </form>
          {% elif vm['status'] == 'Stopped' %}
          <form method="POST" action="{{ url_for('start_sandbox') }}">
            <p><button type="submit" class="btn btn-success">Start Vm</button></p>
          </form>
          {% else %}
            <!-- VM is not available -->
            N/A
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<!-- Add the JavaScript confirmation function at the end of the file -->
<script>
  function confirmShutdown() {
      return confirm("Are you sure you want to shut down the VM?");
  }
</script>

{% endblock %}